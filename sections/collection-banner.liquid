<style>
    #shopify-section-{{ section.id }} .image-overlay {
        --heading-color: {{ section.settings.image_text_color.red }}, {{ section.settings.image_text_color.green }},{{ section.settings.image_text_color.blue }};
        --text-color: {{ section.settings.image_text_color.red }}, {{ section.settings.image_text_color.green }},{{ section.settings.image_text_color.blue }};
        --section-items-alignment: center;
        --section-overlay-color: {{ section.settings.image_overlay_color.red }}, {{ section.settings.image_overlay_color.green }},{{ section.settings.image_overlay_color.blue }};
        --section-overlay-opacity: {{ section.settings.image_overlay_opacity | divided_by: 100.0 }};
    }
</style>

<section>
    {%- comment -%}
    ------------------------------------------------------------------------------------------
    TOP PART (IMAGE AND BREADCRUMB)
    ------------------------------------------------------------------------------------------
    {%- endcomment -%}
    {%- comment -%}
      {%- capture breadcrumb -%}
        <nav aria-label="{{ 'general.breadcrumb.title' | t }}" class="breadcrumb breadcrumb--floating text--xsmall hidden-phone">
          <ol class="breadcrumb__list" role="list">
            <li class="breadcrumb__item">
              <a class="breadcrumb__link" href="{{ routes.root_url }}">{{ 'general.breadcrumb.home' | t }}</a>
            </li>

            <li class="breadcrumb__item">
              <span class="breadcrumb__link" aria-current="page">
                {%- if collection.handle == 'all' -%}
                  {{- 'collection.general.all_products' | t -}}
                {%- else -%}
                  {{- collection.title -}}
                {%- endif -%}
              </span>
            </li>
          </ol>
        </nav>
      {%- endcapture -%}
     {%- endcomment -%}

    {%- if collection.image and section.settings.show_collection_image -%}
        <image-with-text-overlay reveal-on-scroll parallax
                                 class="image-overlay image-overlay--{{ section.settings.section_height }}"
                                 {% if section.settings.section_height == 'auto' %}style="--image-aspect-ratio: {{ collection.image.aspect_ratio }}"{% endif %}>
            <div class="image-overlay__image-wrapper"
                 {% if section.settings.section_height == 'auto' %}style="padding-bottom: {{ 100.0 | divided_by: collection.image.aspect_ratio }}%"{% endif %}>
                {%- comment -%}Performance note: this image must not be lazyloaded as it contributes to the LCP{%- endcomment -%}
                <picture>
                    {%- if section.settings.section_height != 'auto' -%}
                        {{- collection.image | image_url: width: collection.image.width, height: 600, crop: 'center' | image_tag: widths: '400,500,600,700,800,900,1000', media: '(max-width: 740px)' | replace: '<img', '<source' -}}
                    {%- else -%}
                        {{- collection.image | image_url: width: collection.image.width | image_tag: widths: '400,500,600,700,800,900,1000', media: '(max-width: 740px)' | replace: '<img', '<source' -}}
                    {%- endif -%}

                    {{- collection.image | image_url: width: collection.image.width | image_tag: widths: '600,700,800,1000,1200,1400,1600,1800,2000,2200,2400,2600', class: 'image-overlay__image', reveal: true -}}
                </picture>
            </div>

            <div class="container">
                <div class="image-overlay__content-wrapper">
                    {{- breadcrumb -}}

                    <div class="image-overlay__content content-box content-box--{{ section.settings.text_width }} content-box--text-center content-box--center text-container">
                        {%- if section.settings.show_collection_title -%}
                            <h1 class="heading h1">
                                <split-lines reveal>{{ collection.title }}</split-lines>
                            </h1>
                        {%- endif -%}

                        {%- if section.settings.show_collection_description and collection.description != blank -%}
                            <div class="image-overlay__text-container" reveal>
                                {{- collection.description -}}
                            </div>
                        {%- endif -%}
                    </div>
                </div>
            </div>
        </image-with-text-overlay>
    {%- else -%}
        <div class="container">
            <div class="page-header">
                {{- breadcrumb -}}

                <div class="page-header__text-wrapper text-container">
                    {%- if section.settings.show_collection_title -%}
                        <h1 class="heading h1">{{ collection.title }} <span
                                    class="ban_head_icon"> {%- render 'icon' with 'vibr_icon' -%} </span></h1>
                    {%- endif -%}

                    {%- if section.settings.show_collection_description and collection.description != blank -%}
                      <div class="cstm_collection_descp">
                        <div class="descp-wrapper">
                          <div class="descp js-readmore-init-hidden" id="descp">
                            {{ collection.description }}
                          </div>
                        </div>
                      </div>

                    {%- endif -%}
                </div>
            </div>
        </div>
    {%- endif -%}

    {%- comment -%}
    ------------------------------------------------------------------------------------------
    QUICK LINKS PART
    ------------------------------------------------------------------------------------------
    {%- endcomment -%}

    {% assign collection_data = collection.metafields.custom.menu_handle | parse_json %}


    {{ collection_data.text }}

    {%- assign quick_links_menu = section.settings.quick_links -%}

    {%- if quick_links_menu.links.size > 0 -%}
        <link-bar class="link-bar">
            <div class="container">
                <div class="link-bar__wrapper">
                    <span class="link-bar__title heading heading--small text--subdued">{{ quick_links_menu.title }}</span>

                    <div class="link-bar__scroller hide-scrollbar">
                        <ul class="link-bar__linklist list--unstyled" role="list">
                            {%- for link in quick_links_menu.links -%}
                                <li class="link-bar__link-item {% if link.active %}link-bar__link-item--selected{% endif %}">
                                    <a href="{{ link.url }}"
                                       class="link-bar__link link--animated {% if link.active %}text--underlined{% endif %}">{{ link.title }}</a>
                                </li>
                            {%- endfor -%}
                        </ul>
                    </div>
                </div>
            </div>
        </link-bar>
    {%- endif -%}
</section>

{% assign display_nav = false %}

{%- if collection.metafields.custom.sub_nav.value.count > 0 -%}
    {% assign display_nav = true %}
{% endif -%}

{%- if display_nav == false -%}
    {% assign all_tags = "" %}
    {% for product in collection.products %}
        {% for tag in product.metafields.magento.tag_attributes.value %}
            {% unless all_tags contains tag %}
                {% capture all_tags %}{{ all_tags }},{{ tag }}{% endcapture %}
                {% assign display_nav = true %}
            {% endunless %}
        {% endfor %}
    {% endfor %}
{% endif -%}

{%- if display_nav -%}
<div class="{{ collection.title | replace: ' ', '-' }}_tillbarcollection">
    <div class="cstm_collection_nav_item">
        <div class="cstm_collection_nav_item_container container">
            <ul>
                {%- if collection.metafields.custom.sub_nav.value.count > 0 -%}
                    <div class="cstm_collection_title23">
                        <a onclick="history.back()" href="#">Back</a>
                    </div>
                    {%- for sublink in collection.metafields.custom.sub_nav.value -%}
                        <div class="cstm_collection_title23">
                            <a href="{{ sublink.url }}" class="tag-link cstm_banner_tags">{{ sublink.title }}</a>
                        </div>
                    {%- endfor -%}
                {% else %}
                    <div class="cstm_collection_title23 ">
                        <a href="{{ collection.url }}">All</a>
                    </div>
                    {% assign tags_array = all_tags | split: ',' | uniq %}
                    {% for tag in tags_array %}
                        <div class="cstm_collection_title23 ">
                            <a href="{{ collection.url }}?filter.p.m.magento.tag_attributes={{ tag | url_encode }}"
                               class="tag-link cstm_banner_tags">{{ tag }}</a>
                        </div>
                    {% endfor %}
                {%- endif -%}
            </ul>
        </div>
    </div>
</div>
{%- endif -%}

<script>
    //  document.querySelectorAll('.cstm_collection_title a').forEach(link => {


    //   link.addEventListener('click', function(event) {
    //     event.preventDefault(); // Prevent default behavior of navigating to the collection page


    //         const  productCount = document.querySelector('.product-facet__meta-bar .product-facet__meta-bar-item--count')
    //         const cstmPagination = document.querySelector('.pagination')
    //         const showProd = document.querySelector('.product-list')

    //         cstmPagination.style.display = 'none'
    //         showProd.classList.remove("showing_sel_coll")
    //          if(true){
    //            showProd.classList.add("showing_sel_coll")
    //          }


    //     const collectionHandle = this.dataset.collectionHandle; // Get the collection handle from the data attribute


    //     // Fetch only the products from the collection using Shopify's AJAX API
    //     fetch(`${collectionHandle}/products.json`)
    //       .then(response => response.json())
    //       .then(data => {


    //         // Assuming you have a container to display the products
    //         const productList = document.querySelector('.product-list');

    //         productList.innerHTML = ''; // Clear the current product list
    //         // Loop through products and render them
    //         // console.log("888888888 :- ",data.products )
    //         data.products.forEach((product,index) => {

    //           // console.log("99999999 :- ", product)
    //            productCount.innerText = `${data.products.length} products`

    //         // console.log("Product main :- ",product)


    //           const img =  product.images.map(item => item)

    //           let showimg = product.images.length > 0 ? img[0].src : 'path/to/null-image.png';
    //           const price =  product.variants.map(item=> item)

    //           const productItem =   `
    //                  <div class="insideProductListItem" >
    //           <a href="/products/${product.handle}"> <div class="img"><img src="${showimg}" alt="${product.title}" /> </div>  <h3>${product.title} </h3> <div class="price"> $ ${price[0].price} </div> </a>

    //           </div>`;
    //           productList.innerHTML += productItem;
    //         });
    //       })
    //       .catch(error => console.log('Error:', error));


    //   });
    // });
</script>


<!--  Add Active Class -->
<style>
.descp-wrapper {
  position: relative;
  max-width: 100%;
}

</style>

<script>
    const collActive = document.querySelectorAll('.cstm_collection_title23 a')
    let url = new URL(window.location.href);
    let urlParams = new URLSearchParams(url.search);

    collActive.forEach((item, index) => {
        if (urlParams.get('filter.p.m.magento.tag_attributes') == item.innerText) {
            item.classList.add("active_colect")
        }
    })

</script>

{%- if section.settings.show_collection_description and collection.description != blank -%}
<script>
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    const descp = document.getElementById('descp');
    console.log(descp);
    if (!descp) return;
    console.log(descp);

    const originalHTML = descp.innerHTML;
    const originalText = descp.innerText;
    const maxWords = 50;

    const words = originalText.trim().split(/\s+/);
    if (words.length <= maxWords) {
      descp.classList.remove('js-readmore-init-hidden');
      return;
    }

    let wordCount = 0;
    let truncatedHTML = '';

    function truncateNode(node) {
      if (wordCount >= maxWords) return '';

      if (node.nodeType === Node.TEXT_NODE) {
        const nodeWords = node.textContent.trim().split(/\s+/);
        const allowedWords = nodeWords.slice(0, maxWords - wordCount);
        wordCount += allowedWords.length;
        return allowedWords.join(' ') + (wordCount < maxWords ? ' ' : '');
      }

      if (node.nodeType === Node.ELEMENT_NODE) {
        let inner = '';
        node.childNodes.forEach(child => {
          inner += truncateNode(child);
        });
        return `<${node.nodeName.toLowerCase()}${getAttributes(node)}>${inner}</${node.nodeName.toLowerCase()}>`;
      }

      return '';
    }

    function getAttributes(node) {
      if (!node.attributes) return '';
      return Array.from(node.attributes)
        .map(attr => ` ${attr.name}="${attr.value}"`)
        .join('');
    }

    const temp = document.createElement('div');
    temp.innerHTML = originalHTML;
    temp.childNodes.forEach(child => {
      truncatedHTML += truncateNode(child);
    });

    function createButton(text, className) {
      const btn = document.createElement('span');
      btn.innerText = text;
      btn.classList.add(className);
      btn.style.cursor = 'pointer';
      return btn;
    }

    function showTruncated() {
      descp.innerHTML = truncatedHTML.trim();

      const dots = document.createElement('span');
      dots.className = 'read_moredot';
      dots.innerText = '...';

      const readMoreBtn = createButton('Read More', 'read_moretext');

      descp.appendChild(dots);
      descp.appendChild(readMoreBtn);

      readMoreBtn.addEventListener('click', () => {
        showFull();
      });
    }

    function showFull() {
      descp.innerHTML = originalHTML;

      const showLessBtn = createButton('Show Less', 'show_less_btn');
      descp.appendChild(showLessBtn);

      showLessBtn.addEventListener('click', () => {
        showTruncated();
      });
    }

    showTruncated();
    console.log(descp, "descp")
    descp.classList.remove('js-readmore-init-hidden');
    descp.classList.add('js-readmore-visible');

  }, 150);
});
</script>

{%- endif -%}
{% schema %}
{
  "name": "Collection banner",
  "class": "shopify-section--collection-banner",
  "settings": [
    {
      "type": "paragraph",
      "content": "To change collection descriptions or collection images, [edit your collections](/admin/collections)."
    },
    {
      "type": "checkbox",
      "id": "show_collection_image",
      "label": "Show collection image",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_collection_title",
      "label": "Show collection title",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_collection_description",
      "label": "Show collection description",
      "default": true
    },
    {
      "type": "select",
      "id": "section_height",
      "label": "Image height",
      "options": [
        {
          "value": "auto",
          "label": "Original image ratio"
        },
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        }
      ],
      "info": "Choose \"Original image ratio\" to not cut images. [Learn more](https://help.shopify.com/en/manual/online-store/images/theme-images#best-practices-for-slideshows-and-full-width-images)",
      "default": "small"
    },
    {
      "type": "select",
      "id": "text_width",
      "label": "Text width",
      "options": [
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        },
        {
          "value": "fill",
          "label": "Fill screen"
        }
      ],
      "default": "medium"
    },
    {
      "type": "header",
      "content": "Color",
      "info": "Only applicable when collection image is used."
    },
    {
      "type": "color",
      "id": "image_text_color",
      "label": "Text",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "image_overlay_color",
      "label": "Overlay",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "image_overlay_opacity",
      "label": "Overlay opacity",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 30
    },
    {
      "type": "header",
      "content": "Navigation"
    },
    {
      "type": "link_list",
      "id": "quick_links",
      "label": "Quick links",
      "info": "This menu won't show dropdown items."
    }
  ]
}
{% endschema %}